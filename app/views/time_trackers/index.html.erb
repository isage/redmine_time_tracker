<h2><%= l(:time_tracker_list_title) %></h2>

<% has_zombie = false %>

<% if !@user_time_trackers.nil? %>
    <div id="user-time-trackers-list">
        <h3><%= l(:time_tracker_label_your_time_trackers) %></h3>
        <% if !@user_time_trackers.empty? %>
            <div class="autoscroll">
                <table class="list">
                    <thead>
                        <tr>
                            <th class="zombie"></th>
                            <th class="issue"><%= l(:label_issue) %></th>
                            <th class="start-date"><%= l(:time_tracker_label_start_date) %></th>
                            <th class="spent-time"><%= l(:label_spent_time) %></th>
                            <th class="issue"><%= l(:time_tracker_label_status) %></th>
                            <th class="buttons"><%= l(:time_tracker_label_action) %></th>
                        </tr>
                    </thead>

                    <tbody>
                        <% for time_tracker in @user_time_trackers %>
                            <tr id="user-timetracker<%= time_tracker.id %>" class="<%= cycle('odd', 'even') %>">
                                <% if time_tracker.zombie? %>
                                    <% has_zombie = true %>
                                    <td class="zombie icon icon-warning"></td>
                                <% else %>
                                    <td class="zombie"></td>
                                <% end %>
                                <td class="issue"><% if !issue_from_id(time_tracker[:issue_id]).nil? %><%= link_to_issue issue_from_id(time_tracker[:issue_id]), :project => true %><% end %></td>
                                <td class="start-date"><%= format_time(time_tracker[:started_on]) %></td>
                                <td class="spent-time"><%= time_tracker.time_spent_to_s %></td>
                                <td class="issue">
                                <% if time_tracker.paused %>
                                    <span class="tracker_status_row" id="timetracker_status_<%= time_tracker.id.to_s %>"><%= l(:time_tracker_label_status_paused) %></span>
                                <% else %>
                                    <span class="tracker_status_row" id="timetracker_status_<%= time_tracker.id.to_s %>"><%= l(:time_tracker_label_status_running) %></span>
                                <% end %>
                                </td>
                                <td class="buttons">
                                    <% if time_tracker.paused %>
                                        <%= link_to l(:start_time_tracker),
                                            { :controller => '/time_trackers', :action => 'start', :issue_id => time_tracker[:issue_id] },
                                            { :class => 'icon icon-start tracker_start', :title => l(:start_time_tracker), :id =>"tracker_start_" + time_tracker.id.to_s, :remote => true }
                                        %>
                                        <%= link_to l(:suspend_time_tracker),
                                            { :controller => '/time_trackers', :action => 'suspend', :issue_id => time_tracker[:issue_id] },
                                            { :class => 'icon icon-pause tracker_pause', :title => l(:suspend_time_tracker), :id =>"tracker_suspend_" + time_tracker.id.to_s, :style=>"display: none", :remote => true }
                                        %>
                                    <% else %>
                                        <%= link_to l(:start_time_tracker),
                                            { :controller => '/time_trackers', :action => 'start', :issue_id => time_tracker[:issue_id] },
                                            { :class => 'icon icon-start tracker_start', :title => l(:start_time_tracker), :id => "tracker_start_" + time_tracker.id.to_s, :style=>"display: none", :remote => true }
                                        %>
                                        <%= link_to l(:suspend_time_tracker),
                                            { :controller => '/time_trackers', :action => 'suspend', :issue_id => time_tracker[:issue_id] },
                                            { :class => 'icon icon-pause tracker_pause', :title => l(:suspend_time_tracker), :id =>"tracker_suspend_" + time_tracker.id.to_s, :remote => true }
                                        %>
                                    <% end %>
                                    <%= link_to l(:stop_time_tracker),
                                        { :controller => '/time_trackers', :action => 'stop', :issue_id => time_tracker[:issue_id] },
                                        { :class => 'icon icon-stop', :title => l(:stop_time_tracker) }
                                    %>
                                    <%= link_to l(:time_tracker_label_delete),
                                        { :controller => '/time_trackers', :action => 'delete', :id => time_tracker.id },
                                        { :class => 'icon icon-del', :remote => true }
                                    %>

                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        <% else %>
            <p class="msg"><%= l(:no_time_tracker) %></p>
        <% end %>
    </div>
<% end %>

<% if User.current.allowed_to?(:view_others_time_trackers, nil, :global => true) %>
    <div id="all-time-trackers-list">
        <h3><%= l(:time_tracker_label_other_time_trackers) %></h3>
        <% if !@time_trackers.empty? %>
            <div class="autoscroll">
                <table class="list">
                    <thead>
                        <tr>
                            <th class="zombie"></th>
                            <%= sort_header_tag('user_id', :caption => l(:label_user), :default_order => 'desc', :class => 'user') %>
                            <!--th class="user"><%= l(:label_user) %></th-->

                            <%= sort_header_tag('issue_id', :caption => l(:label_issue), :default_order => 'desc', :class => 'issue') %>
                            <!--th class="issue"><%= l(:label_issue) %></th-->

                            <%= sort_header_tag('started_on', :caption => l(:time_tracker_label_start_date), :default_order => 'desc', :class => 'start-date') %>
                            <!--th class="start-date"><%= l(:time_tracker_label_start_date) %></th-->

                            <!--%= sort_header_tag('time_spent', :caption => l(:label_spent_time), :default_order => 'desc', :class => 'spent-time') %-->
                            <th class="spent-time"><%= l(:label_spent_time) %></th>

                            <%= sort_header_tag('paused', :caption => l(:time_tracker_label_status), :default_order => 'desc', :class => 'issue') %>
                            <!--th class="issue"><%= l(:time_tracker_label_status) %></th-->

                            <th class="buttons"><%= l(:time_tracker_label_action) %></th>
                        </tr>
                    </thead>

                    <tbody>
                        <% for time_tracker in @time_trackers %>
                            <tr id="all-timetracker<%= time_tracker.id %>" class="<%= cycle('odd', 'even') %>">
                                <% if time_tracker.zombie? %>
                                    <% has_zombie = true %>
                                    <td class="zombie icon icon-warning"></td>
                                <% else %>
                                    <td class="zombie"></td>
                                <% end %>
                                <td class="user"><%= link_to_user user_from_id(time_tracker[:user_id]) %></td>
                                <td class="issue"><% if !issue_from_id(time_tracker[:issue_id]).nil? %><%= link_to_issue issue_from_id(time_tracker[:issue_id]), :project => true %><% end %></td>
                                <td class="start-date"><%= format_time(time_tracker[:started_on]) %></td>
                                <td class="spent-time"><%= time_tracker.time_spent_to_s %></td>
                                <td class="issue">
                                <% if time_tracker.paused %>
                                    <span class="tracker_status_row" style="color: #999900;" id="timetracker_status_<%= time_tracker.id.to_s %>"><%= l(:time_tracker_label_status_paused) %></span>
                                <% else %>
                                    <span class="tracker_status_row" style="color: #009900;" id="timetracker_status_<%= time_tracker.id.to_s %>"><%= l(:time_tracker_label_status_running) %></span>
                                <% end %>
                                </td>
                                <td class="buttons">
                                    <% if User.current.allowed_to?(:delete_others_time_trackers, nil, :global => true) %>
                                        <%= link_to l(:time_tracker_label_delete),
                                            { :controller => '/time_trackers', :action => 'delete', :id => time_tracker.id },
                                            { :class => 'icon icon-del', :remote => true }
                                        %>
                                    <% end %>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
        <% else %>
            <p class="msg"><%= l(:no_time_tracker) %></p>
        <% end %>
    </div>
<% end %>

<% if has_zombie %>
    <p class="legend icon icon-warning"><%= l(:time_tracker_zombie_legend) %></p>
<% end %>

<script>
function updateTrackersStatus(paused_str, running_str, id, running)
{
    if ($('.tracker_status_row')!='')
    {
        $('.tracker_status_row').each( function() { 
            $(this).html(paused_str);
        });
        if (!running)
        {
            $('.tracker_start').each(function() {$(this).show();});
            $('.tracker_pause').each(function() {$(this).hide();});
            $('#tracker_start_' + id).show();
            $('#tracker_suspend_' + id).hide();
        }
        else
        {
            $('#timetracker_status_' + id).html(running_str);
            $('.tracker_start').each(function() {$(this).show();});
            $('.tracker_pause').each(function() {$(this).hide();});
            $('#tracker_start_' + id).hide();
            $('#tracker_suspend_' + id).show();
        }
    }
}


function updateAfterDelete(event, data, status, xhr){
  $(this).html('<td colspan="7" class="msg"><%=l(:time_tracker_delete_success)%></td>');
  updateMenu();
};

function updateAfterChange(event, data, status, xhr){
  if($(event.target).is("[id^=tracker_start_]"))
    updateTrackersStatus('<%=l(:time_tracker_label_status_paused)%>','<%=l(:time_tracker_label_status_running)%>',event.target.id.replace('tracker_start_',''),true);
  else if($(event.target).is("[id^=tracker_suspend_]"))
    updateTrackersStatus('<%=l(:time_tracker_label_status_paused)%>','<%=l(:time_tracker_label_status_running)%>',event.target.id.replace('tracker_suspend_',''), false);
  else
    $(this).html('<td colspan="6" class="msg"><%=l(:time_tracker_delete_success)%></td>');
  updateMenu();
};

$(document).ready(function(){
  $("[id^=user-timetracker]").each(function(){
    $(this).on("ajax:success", updateAfterChange);
  });

  $("[id^=all-timetracker]").each(function(){
    $(this).on("ajax:success", updateAfterDelete);
  });
});


</script>
